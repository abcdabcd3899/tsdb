--
-- verify the automatically block merging on disordered insertions.
--
-- to have stable output a trick is played that all the data are distributed to
-- the same segment by set the distribution key to the same value in all the
-- rows.
--
-- in the tests we want to verify the block ids of the new, maybe merged, data,
-- and we want to verify the data content, we must verify them separately,
-- because some tests don't have stable data order on param groupkeys.
--
-- NOTE: new test items can only be appended to the template file; if any item
-- is inserted in the middle, all the tests after it will fail due to block id
-- changes.
--
\set tname test_mars_disordered_insert_group_0_0
\set withopts ''
\i sql/disordered_insert.template
create table :tname
     ( c1 int
     , c2 int
     , seg int default 0
     )
 using mars
 :withopts
 distributed by (seg)
;
-- the first batch
insert into :tname
select i / 2 * 100 + 300 as c1
     , i % 2 * 100 + 300 as c2
  from generate_series(0, 3) i
;
-- verify the blocks
select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
(4 rows)

--
-- 1. insert after existing blocks, no block merging is triggered.
--
begin;
    -- 1.1. one row
    insert into :tname values ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
 (2,1) | 500 | 500
(5 rows)

abort;
begin;
    -- 1.2. multiple rows, maybe in different groups
    insert into :tname values ( 500, 500 ), ( 520, 520 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
 (3,1) | 500 | 500
 (3,2) | 520 | 520
(6 rows)

abort;
begin;
    -- 1.3. multiple rows, maybe in the same group
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
 (4,1) | 500 | 500
 (4,2) | 501 | 501
(6 rows)

abort;
begin;
    -- 1.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 501, 501 ), ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
 (5,1) | 501 | 501
 (5,2) | 500 | 500
(6 rows)

abort;
begin;
    -- 1.5. multiple inserts
    insert into :tname values ( 601, 601 ), ( 600, 600 );
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
 (6,1) | 601 | 601
 (6,2) | 600 | 600
 (7,1) | 500 | 500
 (7,2) | 501 | 501
(8 rows)

abort;
--
-- 2. insert before existing blocks, no block merging is triggered.
--
begin;
    -- 2.1. one row
    insert into :tname values ( 100, 100 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
 (8,1) | 100 | 100
(5 rows)

abort;
begin;
    -- 2.2. multiple rows, maybe in different groups
    insert into :tname values ( 100, 100 ), ( 120, 120 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
 (9,1) | 100 | 100
 (9,2) | 120 | 120
(6 rows)

abort;
begin;
    -- 2.3. multiple rows, maybe in the same group
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (1,3)  | 400 | 300
 (1,4)  | 400 | 400
 (10,1) | 100 | 100
 (10,2) | 101 | 101
(6 rows)

abort;
begin;
    -- 2.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 101, 101 ), ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (1,3)  | 400 | 300
 (1,4)  | 400 | 400
 (11,1) | 101 | 101
 (11,2) | 100 | 100
(6 rows)

abort;
begin;
    -- 2.5. multiple inserts
    insert into :tname values ( 201, 201 ), ( 200, 200 );
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (1,3)  | 400 | 300
 (1,4)  | 400 | 400
 (12,1) | 201 | 201
 (12,2) | 200 | 200
 (13,1) | 100 | 100
 (13,2) | 101 | 101
(8 rows)

abort;
--
-- 3. overlaps with existing blocks, block merging is triggered.
--
begin;
    -- 3.1. one row
    insert into :tname values ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (14,1)
(5 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 400 | 300
 400 | 400
(5 rows)

abort;
begin;
    -- 3.2. multiple rows, maybe in different groups
    insert into :tname values ( 300, 300 ), ( 320, 320 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (15,1)
 (15,2)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 320 | 320
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.3. multiple rows, maybe in the same group
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (16,1)
 (16,2)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 301, 301 ), ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (17,1)
 (17,2)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.5. multiple inserts
    insert into :tname values ( 401, 401 ), ( 400, 400 );
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (18,1)
 (18,2)
 (19,1)
 (19,2)
(8 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
(8 rows)

abort;
--
-- 4. other tests
--
begin;
    -- 4.1. overlaps with multiple existing blocks
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 401, 401 ), ( 400, 400 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (20,1)
 (20,2)
 (20,3)
 (20,4)
 (20,5)
 (20,6)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
 500 | 500
 501 | 501
(10 rows)

abort;
begin;
    -- 4.2. merge multiple times
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 303, 303 ), ( 302, 302 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (21,1)
 (21,2)
 (21,3)
 (21,4)
 (21,5)
 (21,6)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 302 | 302
 303 | 303
 400 | 300
 400 | 400
 500 | 500
 501 | 501
(10 rows)

abort;
-- vi: syntax=sql et :
\set tname test_mars_disordered_insert_group_1_0
\set withopts 'with (group_col_=''{c1}'')'
\i sql/disordered_insert.template
create table :tname
     ( c1 int
     , c2 int
     , seg int default 0
     )
 using mars
 :withopts
 distributed by (seg)
;
-- the first batch
insert into :tname
select i / 2 * 100 + 300 as c1
     , i % 2 * 100 + 300 as c2
  from generate_series(0, 3) i
;
-- verify the blocks
select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
(4 rows)

--
-- 1. insert after existing blocks, no block merging is triggered.
--
begin;
    -- 1.1. one row
    insert into :tname values ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (3,1) | 500 | 500
(5 rows)

abort;
begin;
    -- 1.2. multiple rows, maybe in different groups
    insert into :tname values ( 500, 500 ), ( 520, 520 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (4,1) | 500 | 500
 (5,1) | 520 | 520
(6 rows)

abort;
begin;
    -- 1.3. multiple rows, maybe in the same group
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (6,1) | 500 | 500
 (7,1) | 501 | 501
(6 rows)

abort;
begin;
    -- 1.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 501, 501 ), ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (8,1) | 501 | 501
 (9,1) | 500 | 500
(6 rows)

abort;
begin;
    -- 1.5. multiple inserts
    insert into :tname values ( 601, 601 ), ( 600, 600 );
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (10,1) | 601 | 601
 (11,1) | 600 | 600
 (12,1) | 500 | 500
 (13,1) | 501 | 501
(8 rows)

abort;
--
-- 2. insert before existing blocks, no block merging is triggered.
--
begin;
    -- 2.1. one row
    insert into :tname values ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (14,1) | 100 | 100
(5 rows)

abort;
begin;
    -- 2.2. multiple rows, maybe in different groups
    insert into :tname values ( 100, 100 ), ( 120, 120 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (15,1) | 100 | 100
 (16,1) | 120 | 120
(6 rows)

abort;
begin;
    -- 2.3. multiple rows, maybe in the same group
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (17,1) | 100 | 100
 (18,1) | 101 | 101
(6 rows)

abort;
begin;
    -- 2.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 101, 101 ), ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (19,1) | 101 | 101
 (20,1) | 100 | 100
(6 rows)

abort;
begin;
    -- 2.5. multiple inserts
    insert into :tname values ( 201, 201 ), ( 200, 200 );
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (21,1) | 201 | 201
 (22,1) | 200 | 200
 (23,1) | 100 | 100
 (24,1) | 101 | 101
(8 rows)

abort;
--
-- 3. overlaps with existing blocks, block merging is triggered.
--
begin;
    -- 3.1. one row
    insert into :tname values ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (25,1)
 (25,2)
 (25,3)
(5 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 400 | 300
 400 | 400
(5 rows)

abort;
begin;
    -- 3.2. multiple rows, maybe in different groups
    insert into :tname values ( 300, 300 ), ( 320, 320 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (26,1)
 (26,2)
 (26,3)
 (27,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 320 | 320
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.3. multiple rows, maybe in the same group
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (28,1)
 (28,2)
 (28,3)
 (29,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 301, 301 ), ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (31,1)
 (31,2)
 (31,3)
 (30,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.5. multiple inserts
    insert into :tname values ( 401, 401 ), ( 400, 400 );
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (33,1)
 (33,2)
 (33,3)
 (34,1)
 (34,2)
 (34,3)
 (32,1)
 (35,1)
(8 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
(8 rows)

abort;
--
-- 4. other tests
--
begin;
    -- 4.1. overlaps with multiple existing blocks
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 401, 401 ), ( 400, 400 );
    select ctid from :tname;
  ctid  
--------
 (36,1)
 (36,2)
 (36,3)
 (41,1)
 (41,2)
 (41,3)
 (37,1)
 (38,1)
 (39,1)
 (40,1)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
 500 | 500
 501 | 501
(10 rows)

abort;
begin;
    -- 4.2. merge multiple times
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 303, 303 ), ( 302, 302 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (42,1)
 (42,2)
 (42,3)
 (43,1)
 (44,1)
 (45,1)
 (46,1)
 (47,1)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 302 | 302
 303 | 303
 400 | 300
 400 | 400
 500 | 500
 501 | 501
(10 rows)

abort;
-- vi: syntax=sql et :
\set tname test_mars_disordered_insert_group_4_0
\set withopts 'with (group_param_col_=''{c1 in 4}'')'
\i sql/disordered_insert.template
create table :tname
     ( c1 int
     , c2 int
     , seg int default 0
     )
 using mars
 :withopts
 distributed by (seg)
;
-- the first batch
insert into :tname
select i / 2 * 100 + 300 as c1
     , i % 2 * 100 + 300 as c2
  from generate_series(0, 3) i
;
-- verify the blocks
select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
(4 rows)

--
-- 1. insert after existing blocks, no block merging is triggered.
--
begin;
    -- 1.1. one row
    insert into :tname values ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (3,1) | 500 | 500
(5 rows)

abort;
begin;
    -- 1.2. multiple rows, maybe in different groups
    insert into :tname values ( 500, 500 ), ( 520, 520 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (4,1) | 500 | 500
 (5,1) | 520 | 520
(6 rows)

abort;
begin;
    -- 1.3. multiple rows, maybe in the same group
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (6,1) | 500 | 500
 (6,2) | 501 | 501
(6 rows)

abort;
begin;
    -- 1.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 501, 501 ), ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (7,1) | 500 | 500
 (7,2) | 501 | 501
(6 rows)

abort;
begin;
    -- 1.5. multiple inserts
    insert into :tname values ( 601, 601 ), ( 600, 600 );
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (8,1) | 600 | 600
 (8,2) | 601 | 601
 (9,1) | 500 | 500
 (9,2) | 501 | 501
(8 rows)

abort;
--
-- 2. insert before existing blocks, no block merging is triggered.
--
begin;
    -- 2.1. one row
    insert into :tname values ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (10,1) | 100 | 100
(5 rows)

abort;
begin;
    -- 2.2. multiple rows, maybe in different groups
    insert into :tname values ( 100, 100 ), ( 120, 120 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (11,1) | 100 | 100
 (12,1) | 120 | 120
(6 rows)

abort;
begin;
    -- 2.3. multiple rows, maybe in the same group
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (13,1) | 100 | 100
 (13,2) | 101 | 101
(6 rows)

abort;
begin;
    -- 2.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 101, 101 ), ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (14,1) | 100 | 100
 (14,2) | 101 | 101
(6 rows)

abort;
begin;
    -- 2.5. multiple inserts
    insert into :tname values ( 201, 201 ), ( 200, 200 );
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (15,1) | 200 | 200
 (15,2) | 201 | 201
 (16,1) | 100 | 100
 (16,2) | 101 | 101
(8 rows)

abort;
--
-- 3. overlaps with existing blocks, block merging is triggered.
--
begin;
    -- 3.1. one row
    insert into :tname values ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (17,1)
 (17,2)
 (17,3)
(5 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 400 | 300
 400 | 400
(5 rows)

abort;
begin;
    -- 3.2. multiple rows, maybe in different groups
    insert into :tname values ( 300, 300 ), ( 320, 320 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (18,1)
 (18,2)
 (18,3)
 (19,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 320 | 320
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.3. multiple rows, maybe in the same group
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (20,1)
 (20,2)
 (20,3)
 (20,4)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 301, 301 ), ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (21,1)
 (21,2)
 (21,3)
 (21,4)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.5. multiple inserts
    insert into :tname values ( 401, 401 ), ( 400, 400 );
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (22,1)
 (22,2)
 (22,3)
 (22,4)
 (23,1)
 (23,2)
 (23,3)
 (23,4)
(8 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
(8 rows)

abort;
--
-- 4. other tests
--
begin;
    -- 4.1. overlaps with multiple existing blocks
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 401, 401 ), ( 400, 400 );
    select ctid from :tname;
  ctid  
--------
 (24,1)
 (24,2)
 (24,3)
 (24,4)
 (26,1)
 (26,2)
 (26,3)
 (26,4)
 (25,1)
 (25,2)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
 500 | 500
 501 | 501
(10 rows)

abort;
begin;
    -- 4.2. merge multiple times
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 303, 303 ), ( 302, 302 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (29,1)
 (29,2)
 (29,3)
 (29,4)
 (29,5)
 (29,6)
 (28,1)
 (28,2)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 302 | 302
 303 | 303
 400 | 300
 400 | 400
 500 | 500
 501 | 501
(10 rows)

abort;
-- vi: syntax=sql et :
\set tname test_mars_disordered_insert_group_1_4
\set withopts 'with (group_col_=''{c1}'', group_param_col_=''{c2 in 4}'')'
\i sql/disordered_insert.template
create table :tname
     ( c1 int
     , c2 int
     , seg int default 0
     )
 using mars
 :withopts
 distributed by (seg)
;
-- the first batch
insert into :tname
select i / 2 * 100 + 300 as c1
     , i % 2 * 100 + 300 as c2
  from generate_series(0, 3) i
;
-- verify the blocks
select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (2,1) | 300 | 400
 (3,1) | 400 | 300
 (4,1) | 400 | 400
(4 rows)

--
-- 1. insert after existing blocks, no block merging is triggered.
--
begin;
    -- 1.1. one row
    insert into :tname values ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (2,1) | 300 | 400
 (3,1) | 400 | 300
 (4,1) | 400 | 400
 (5,1) | 500 | 500
(5 rows)

abort;
begin;
    -- 1.2. multiple rows, maybe in different groups
    insert into :tname values ( 500, 500 ), ( 520, 520 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (2,1) | 300 | 400
 (3,1) | 400 | 300
 (4,1) | 400 | 400
 (6,1) | 500 | 500
 (7,1) | 520 | 520
(6 rows)

abort;
begin;
    -- 1.3. multiple rows, maybe in the same group
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (2,1) | 300 | 400
 (3,1) | 400 | 300
 (4,1) | 400 | 400
 (8,1) | 500 | 500
 (9,1) | 501 | 501
(6 rows)

abort;
begin;
    -- 1.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 501, 501 ), ( 500, 500 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (10,1) | 501 | 501
 (11,1) | 500 | 500
(6 rows)

abort;
begin;
    -- 1.5. multiple inserts
    insert into :tname values ( 601, 601 ), ( 600, 600 );
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (12,1) | 601 | 601
 (13,1) | 600 | 600
 (14,1) | 500 | 500
 (15,1) | 501 | 501
(8 rows)

abort;
--
-- 2. insert before existing blocks, no block merging is triggered.
--
begin;
    -- 2.1. one row
    insert into :tname values ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (16,1) | 100 | 100
(5 rows)

abort;
begin;
    -- 2.2. multiple rows, maybe in different groups
    insert into :tname values ( 100, 100 ), ( 120, 120 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (17,1) | 100 | 100
 (18,1) | 120 | 120
(6 rows)

abort;
begin;
    -- 2.3. multiple rows, maybe in the same group
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (19,1) | 100 | 100
 (20,1) | 101 | 101
(6 rows)

abort;
begin;
    -- 2.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 101, 101 ), ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (21,1) | 101 | 101
 (22,1) | 100 | 100
(6 rows)

abort;
begin;
    -- 2.5. multiple inserts
    insert into :tname values ( 201, 201 ), ( 200, 200 );
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (23,1) | 201 | 201
 (24,1) | 200 | 200
 (25,1) | 100 | 100
 (26,1) | 101 | 101
(8 rows)

abort;
--
-- 3. overlaps with existing blocks, block merging is triggered.
--
begin;
    -- 3.1. one row
    insert into :tname values ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (4,1)
 (27,1)
 (27,2)
(5 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 400 | 300
 400 | 400
(5 rows)

abort;
begin;
    -- 3.2. multiple rows, maybe in different groups
    insert into :tname values ( 300, 300 ), ( 320, 320 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (4,1)
 (28,1)
 (28,2)
 (29,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 320 | 320
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.3. multiple rows, maybe in the same group
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (4,1)
 (30,1)
 (30,2)
 (31,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 301, 301 ), ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (4,1)
 (33,1)
 (33,2)
 (32,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.5. multiple inserts
    insert into :tname values ( 401, 401 ), ( 400, 400 );
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (35,1)
 (35,2)
 (36,1)
 (36,2)
 (34,1)
 (37,1)
(8 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
(8 rows)

abort;
--
-- 4. other tests
--
begin;
    -- 4.1. overlaps with multiple existing blocks
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 401, 401 ), ( 400, 400 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (38,1)
 (38,2)
 (43,1)
 (43,2)
 (39,1)
 (40,1)
 (41,1)
 (42,1)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
 500 | 500
 501 | 501
(10 rows)

abort;
begin;
    -- 4.2. merge multiple times
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 303, 303 ), ( 302, 302 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (4,1)
 (44,1)
 (44,2)
 (45,1)
 (46,1)
 (47,1)
 (48,1)
 (49,1)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 302 | 302
 303 | 303
 400 | 300
 400 | 400
 500 | 500
 501 | 501
(10 rows)

abort;
-- vi: syntax=sql et :
\set tname test_mars_disordered_insert_group_1_0_order1
\set withopts 'with (group_col_=''{c1}'', local_order_col_=''{c1}'')'
\i sql/disordered_insert.template
create table :tname
     ( c1 int
     , c2 int
     , seg int default 0
     )
 using mars
 :withopts
 distributed by (seg)
;
-- the first batch
insert into :tname
select i / 2 * 100 + 300 as c1
     , i % 2 * 100 + 300 as c2
  from generate_series(0, 3) i
;
-- verify the blocks
select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
(4 rows)

--
-- 1. insert after existing blocks, no block merging is triggered.
--
begin;
    -- 1.1. one row
    insert into :tname values ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (3,1) | 500 | 500
(5 rows)

abort;
begin;
    -- 1.2. multiple rows, maybe in different groups
    insert into :tname values ( 500, 500 ), ( 520, 520 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (4,1) | 500 | 500
 (5,1) | 520 | 520
(6 rows)

abort;
begin;
    -- 1.3. multiple rows, maybe in the same group
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (6,1) | 500 | 500
 (7,1) | 501 | 501
(6 rows)

abort;
begin;
    -- 1.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 501, 501 ), ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (8,1) | 501 | 501
 (9,1) | 500 | 500
(6 rows)

abort;
begin;
    -- 1.5. multiple inserts
    insert into :tname values ( 601, 601 ), ( 600, 600 );
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (10,1) | 601 | 601
 (11,1) | 600 | 600
 (12,1) | 500 | 500
 (13,1) | 501 | 501
(8 rows)

abort;
--
-- 2. insert before existing blocks, no block merging is triggered.
--
begin;
    -- 2.1. one row
    insert into :tname values ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (14,1) | 100 | 100
(5 rows)

abort;
begin;
    -- 2.2. multiple rows, maybe in different groups
    insert into :tname values ( 100, 100 ), ( 120, 120 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (15,1) | 100 | 100
 (16,1) | 120 | 120
(6 rows)

abort;
begin;
    -- 2.3. multiple rows, maybe in the same group
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (17,1) | 100 | 100
 (18,1) | 101 | 101
(6 rows)

abort;
begin;
    -- 2.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 101, 101 ), ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (19,1) | 101 | 101
 (20,1) | 100 | 100
(6 rows)

abort;
begin;
    -- 2.5. multiple inserts
    insert into :tname values ( 201, 201 ), ( 200, 200 );
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (21,1) | 201 | 201
 (22,1) | 200 | 200
 (23,1) | 100 | 100
 (24,1) | 101 | 101
(8 rows)

abort;
--
-- 3. overlaps with existing blocks, block merging is triggered.
--
begin;
    -- 3.1. one row
    insert into :tname values ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (25,1)
 (25,2)
 (25,3)
(5 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 400 | 300
 400 | 400
(5 rows)

abort;
begin;
    -- 3.2. multiple rows, maybe in different groups
    insert into :tname values ( 300, 300 ), ( 320, 320 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (26,1)
 (26,2)
 (26,3)
 (27,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 320 | 320
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.3. multiple rows, maybe in the same group
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (28,1)
 (28,2)
 (28,3)
 (29,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 301, 301 ), ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (31,1)
 (31,2)
 (31,3)
 (30,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.5. multiple inserts
    insert into :tname values ( 401, 401 ), ( 400, 400 );
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (33,1)
 (33,2)
 (33,3)
 (34,1)
 (34,2)
 (34,3)
 (32,1)
 (35,1)
(8 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
(8 rows)

abort;
--
-- 4. other tests
--
begin;
    -- 4.1. overlaps with multiple existing blocks
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 401, 401 ), ( 400, 400 );
    select ctid from :tname;
  ctid  
--------
 (36,1)
 (36,2)
 (36,3)
 (41,1)
 (41,2)
 (41,3)
 (37,1)
 (38,1)
 (39,1)
 (40,1)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
 500 | 500
 501 | 501
(10 rows)

abort;
begin;
    -- 4.2. merge multiple times
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 303, 303 ), ( 302, 302 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (42,1)
 (42,2)
 (42,3)
 (43,1)
 (44,1)
 (45,1)
 (46,1)
 (47,1)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 302 | 302
 303 | 303
 400 | 300
 400 | 400
 500 | 500
 501 | 501
(10 rows)

abort;
-- vi: syntax=sql et :
\set tname test_mars_disordered_insert_group_1_0_order2
\set withopts 'with (group_col_=''{c1}'', local_order_col_=''{c2}'')'
\i sql/disordered_insert.template
create table :tname
     ( c1 int
     , c2 int
     , seg int default 0
     )
 using mars
 :withopts
 distributed by (seg)
;
-- the first batch
insert into :tname
select i / 2 * 100 + 300 as c1
     , i % 2 * 100 + 300 as c2
  from generate_series(0, 3) i
;
-- verify the blocks
select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
(4 rows)

--
-- 1. insert after existing blocks, no block merging is triggered.
--
begin;
    -- 1.1. one row
    insert into :tname values ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (3,1) | 500 | 500
(5 rows)

abort;
begin;
    -- 1.2. multiple rows, maybe in different groups
    insert into :tname values ( 500, 500 ), ( 520, 520 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (4,1) | 500 | 500
 (5,1) | 520 | 520
(6 rows)

abort;
begin;
    -- 1.3. multiple rows, maybe in the same group
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (6,1) | 500 | 500
 (7,1) | 501 | 501
(6 rows)

abort;
begin;
    -- 1.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 501, 501 ), ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (8,1) | 501 | 501
 (9,1) | 500 | 500
(6 rows)

abort;
begin;
    -- 1.5. multiple inserts
    insert into :tname values ( 601, 601 ), ( 600, 600 );
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (10,1) | 601 | 601
 (11,1) | 600 | 600
 (12,1) | 500 | 500
 (13,1) | 501 | 501
(8 rows)

abort;
--
-- 2. insert before existing blocks, no block merging is triggered.
--
begin;
    -- 2.1. one row
    insert into :tname values ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (14,1) | 100 | 100
(5 rows)

abort;
begin;
    -- 2.2. multiple rows, maybe in different groups
    insert into :tname values ( 100, 100 ), ( 120, 120 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (15,1) | 100 | 100
 (16,1) | 120 | 120
(6 rows)

abort;
begin;
    -- 2.3. multiple rows, maybe in the same group
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (17,1) | 100 | 100
 (18,1) | 101 | 101
(6 rows)

abort;
begin;
    -- 2.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 101, 101 ), ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (19,1) | 101 | 101
 (20,1) | 100 | 100
(6 rows)

abort;
begin;
    -- 2.5. multiple inserts
    insert into :tname values ( 201, 201 ), ( 200, 200 );
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (21,1) | 201 | 201
 (22,1) | 200 | 200
 (23,1) | 100 | 100
 (24,1) | 101 | 101
(8 rows)

abort;
--
-- 3. overlaps with existing blocks, block merging is triggered.
--
begin;
    -- 3.1. one row
    insert into :tname values ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (25,1)
 (25,2)
 (25,3)
(5 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 400 | 300
 400 | 400
(5 rows)

abort;
begin;
    -- 3.2. multiple rows, maybe in different groups
    insert into :tname values ( 300, 300 ), ( 320, 320 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (26,1)
 (26,2)
 (26,3)
 (27,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 320 | 320
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.3. multiple rows, maybe in the same group
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (28,1)
 (28,2)
 (28,3)
 (29,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 301, 301 ), ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (31,1)
 (31,2)
 (31,3)
 (30,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.5. multiple inserts
    insert into :tname values ( 401, 401 ), ( 400, 400 );
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (33,1)
 (33,2)
 (33,3)
 (34,1)
 (34,2)
 (34,3)
 (32,1)
 (35,1)
(8 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
(8 rows)

abort;
--
-- 4. other tests
--
begin;
    -- 4.1. overlaps with multiple existing blocks
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 401, 401 ), ( 400, 400 );
    select ctid from :tname;
  ctid  
--------
 (36,1)
 (36,2)
 (36,3)
 (41,1)
 (41,2)
 (41,3)
 (37,1)
 (38,1)
 (39,1)
 (40,1)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
 500 | 500
 501 | 501
(10 rows)

abort;
begin;
    -- 4.2. merge multiple times
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 303, 303 ), ( 302, 302 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (42,1)
 (42,2)
 (42,3)
 (43,1)
 (44,1)
 (45,1)
 (46,1)
 (47,1)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 302 | 302
 303 | 303
 400 | 300
 400 | 400
 500 | 500
 501 | 501
(10 rows)

abort;
-- vi: syntax=sql et :
\set tname test_mars_disordered_insert_group_1_0_order12
\set withopts 'with (group_col_=''{c1}'', local_order_col_=''{c1, c2}'')'
\i sql/disordered_insert.template
create table :tname
     ( c1 int
     , c2 int
     , seg int default 0
     )
 using mars
 :withopts
 distributed by (seg)
;
-- the first batch
insert into :tname
select i / 2 * 100 + 300 as c1
     , i % 2 * 100 + 300 as c2
  from generate_series(0, 3) i
;
-- verify the blocks
select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
(4 rows)

--
-- 1. insert after existing blocks, no block merging is triggered.
--
begin;
    -- 1.1. one row
    insert into :tname values ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (3,1) | 500 | 500
(5 rows)

abort;
begin;
    -- 1.2. multiple rows, maybe in different groups
    insert into :tname values ( 500, 500 ), ( 520, 520 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (4,1) | 500 | 500
 (5,1) | 520 | 520
(6 rows)

abort;
begin;
    -- 1.3. multiple rows, maybe in the same group
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (6,1) | 500 | 500
 (7,1) | 501 | 501
(6 rows)

abort;
begin;
    -- 1.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 501, 501 ), ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (8,1) | 501 | 501
 (9,1) | 500 | 500
(6 rows)

abort;
begin;
    -- 1.5. multiple inserts
    insert into :tname values ( 601, 601 ), ( 600, 600 );
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (10,1) | 601 | 601
 (11,1) | 600 | 600
 (12,1) | 500 | 500
 (13,1) | 501 | 501
(8 rows)

abort;
--
-- 2. insert before existing blocks, no block merging is triggered.
--
begin;
    -- 2.1. one row
    insert into :tname values ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (14,1) | 100 | 100
(5 rows)

abort;
begin;
    -- 2.2. multiple rows, maybe in different groups
    insert into :tname values ( 100, 100 ), ( 120, 120 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (15,1) | 100 | 100
 (16,1) | 120 | 120
(6 rows)

abort;
begin;
    -- 2.3. multiple rows, maybe in the same group
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (17,1) | 100 | 100
 (18,1) | 101 | 101
(6 rows)

abort;
begin;
    -- 2.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 101, 101 ), ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (19,1) | 101 | 101
 (20,1) | 100 | 100
(6 rows)

abort;
begin;
    -- 2.5. multiple inserts
    insert into :tname values ( 201, 201 ), ( 200, 200 );
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (21,1) | 201 | 201
 (22,1) | 200 | 200
 (23,1) | 100 | 100
 (24,1) | 101 | 101
(8 rows)

abort;
--
-- 3. overlaps with existing blocks, block merging is triggered.
--
begin;
    -- 3.1. one row
    insert into :tname values ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (25,1)
 (25,2)
 (25,3)
(5 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 400 | 300
 400 | 400
(5 rows)

abort;
begin;
    -- 3.2. multiple rows, maybe in different groups
    insert into :tname values ( 300, 300 ), ( 320, 320 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (26,1)
 (26,2)
 (26,3)
 (27,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 320 | 320
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.3. multiple rows, maybe in the same group
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (28,1)
 (28,2)
 (28,3)
 (29,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 301, 301 ), ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (31,1)
 (31,2)
 (31,3)
 (30,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.5. multiple inserts
    insert into :tname values ( 401, 401 ), ( 400, 400 );
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (33,1)
 (33,2)
 (33,3)
 (34,1)
 (34,2)
 (34,3)
 (32,1)
 (35,1)
(8 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
(8 rows)

abort;
--
-- 4. other tests
--
begin;
    -- 4.1. overlaps with multiple existing blocks
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 401, 401 ), ( 400, 400 );
    select ctid from :tname;
  ctid  
--------
 (36,1)
 (36,2)
 (36,3)
 (41,1)
 (41,2)
 (41,3)
 (37,1)
 (38,1)
 (39,1)
 (40,1)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
 500 | 500
 501 | 501
(10 rows)

abort;
begin;
    -- 4.2. merge multiple times
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 303, 303 ), ( 302, 302 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (42,1)
 (42,2)
 (42,3)
 (43,1)
 (44,1)
 (45,1)
 (46,1)
 (47,1)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 302 | 302
 303 | 303
 400 | 300
 400 | 400
 500 | 500
 501 | 501
(10 rows)

abort;
-- vi: syntax=sql et :
\set tname test_mars_disordered_insert_group_4_0_order1
\set withopts 'with (group_param_col_=''{c1 in 4}'', local_order_col_=''{c1}'')'
\i sql/disordered_insert.template
create table :tname
     ( c1 int
     , c2 int
     , seg int default 0
     )
 using mars
 :withopts
 distributed by (seg)
;
-- the first batch
insert into :tname
select i / 2 * 100 + 300 as c1
     , i % 2 * 100 + 300 as c2
  from generate_series(0, 3) i
;
-- verify the blocks
select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
(4 rows)

--
-- 1. insert after existing blocks, no block merging is triggered.
--
begin;
    -- 1.1. one row
    insert into :tname values ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (3,1) | 500 | 500
(5 rows)

abort;
begin;
    -- 1.2. multiple rows, maybe in different groups
    insert into :tname values ( 500, 500 ), ( 520, 520 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (4,1) | 500 | 500
 (5,1) | 520 | 520
(6 rows)

abort;
begin;
    -- 1.3. multiple rows, maybe in the same group
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (6,1) | 500 | 500
 (6,2) | 501 | 501
(6 rows)

abort;
begin;
    -- 1.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 501, 501 ), ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (7,1) | 500 | 500
 (7,2) | 501 | 501
(6 rows)

abort;
begin;
    -- 1.5. multiple inserts
    insert into :tname values ( 601, 601 ), ( 600, 600 );
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (8,1) | 600 | 600
 (8,2) | 601 | 601
 (9,1) | 500 | 500
 (9,2) | 501 | 501
(8 rows)

abort;
--
-- 2. insert before existing blocks, no block merging is triggered.
--
begin;
    -- 2.1. one row
    insert into :tname values ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (10,1) | 100 | 100
(5 rows)

abort;
begin;
    -- 2.2. multiple rows, maybe in different groups
    insert into :tname values ( 100, 100 ), ( 120, 120 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (11,1) | 100 | 100
 (12,1) | 120 | 120
(6 rows)

abort;
begin;
    -- 2.3. multiple rows, maybe in the same group
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (13,1) | 100 | 100
 (13,2) | 101 | 101
(6 rows)

abort;
begin;
    -- 2.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 101, 101 ), ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (14,1) | 100 | 100
 (14,2) | 101 | 101
(6 rows)

abort;
begin;
    -- 2.5. multiple inserts
    insert into :tname values ( 201, 201 ), ( 200, 200 );
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (15,1) | 200 | 200
 (15,2) | 201 | 201
 (16,1) | 100 | 100
 (16,2) | 101 | 101
(8 rows)

abort;
--
-- 3. overlaps with existing blocks, block merging is triggered.
--
begin;
    -- 3.1. one row
    insert into :tname values ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (17,1)
 (17,2)
 (17,3)
(5 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 400 | 300
 400 | 400
(5 rows)

abort;
begin;
    -- 3.2. multiple rows, maybe in different groups
    insert into :tname values ( 300, 300 ), ( 320, 320 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (18,1)
 (18,2)
 (18,3)
 (19,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 320 | 320
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.3. multiple rows, maybe in the same group
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (20,1)
 (20,2)
 (20,3)
 (20,4)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 301, 301 ), ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (21,1)
 (21,2)
 (21,3)
 (21,4)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.5. multiple inserts
    insert into :tname values ( 401, 401 ), ( 400, 400 );
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (22,1)
 (22,2)
 (22,3)
 (22,4)
 (23,1)
 (23,2)
 (23,3)
 (23,4)
(8 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
(8 rows)

abort;
--
-- 4. other tests
--
begin;
    -- 4.1. overlaps with multiple existing blocks
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 401, 401 ), ( 400, 400 );
    select ctid from :tname;
  ctid  
--------
 (24,1)
 (24,2)
 (24,3)
 (24,4)
 (26,1)
 (26,2)
 (26,3)
 (26,4)
 (25,1)
 (25,2)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
 500 | 500
 501 | 501
(10 rows)

abort;
begin;
    -- 4.2. merge multiple times
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 303, 303 ), ( 302, 302 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (29,1)
 (29,2)
 (29,3)
 (29,4)
 (29,5)
 (29,6)
 (28,1)
 (28,2)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 302 | 302
 303 | 303
 400 | 300
 400 | 400
 500 | 500
 501 | 501
(10 rows)

abort;
-- vi: syntax=sql et :
\set tname test_mars_disordered_insert_group_4_0_order2
\set withopts 'with (group_param_col_=''{c1 in 4}'', local_order_col_=''{c2}'')'
\i sql/disordered_insert.template
create table :tname
     ( c1 int
     , c2 int
     , seg int default 0
     )
 using mars
 :withopts
 distributed by (seg)
;
-- the first batch
insert into :tname
select i / 2 * 100 + 300 as c1
     , i % 2 * 100 + 300 as c2
  from generate_series(0, 3) i
;
-- verify the blocks
select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
(4 rows)

--
-- 1. insert after existing blocks, no block merging is triggered.
--
begin;
    -- 1.1. one row
    insert into :tname values ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (3,1) | 500 | 500
(5 rows)

abort;
begin;
    -- 1.2. multiple rows, maybe in different groups
    insert into :tname values ( 500, 500 ), ( 520, 520 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (4,1) | 500 | 500
 (5,1) | 520 | 520
(6 rows)

abort;
begin;
    -- 1.3. multiple rows, maybe in the same group
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (6,1) | 500 | 500
 (6,2) | 501 | 501
(6 rows)

abort;
begin;
    -- 1.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 501, 501 ), ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (7,1) | 500 | 500
 (7,2) | 501 | 501
(6 rows)

abort;
begin;
    -- 1.5. multiple inserts
    insert into :tname values ( 601, 601 ), ( 600, 600 );
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (2,1) | 400 | 300
 (2,2) | 400 | 400
 (8,1) | 600 | 600
 (8,2) | 601 | 601
 (9,1) | 500 | 500
 (9,2) | 501 | 501
(8 rows)

abort;
--
-- 2. insert before existing blocks, no block merging is triggered.
--
begin;
    -- 2.1. one row
    insert into :tname values ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (10,1) | 100 | 100
(5 rows)

abort;
begin;
    -- 2.2. multiple rows, maybe in different groups
    insert into :tname values ( 100, 100 ), ( 120, 120 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (11,1) | 100 | 100
 (12,1) | 120 | 120
(6 rows)

abort;
begin;
    -- 2.3. multiple rows, maybe in the same group
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (13,1) | 100 | 100
 (13,2) | 101 | 101
(6 rows)

abort;
begin;
    -- 2.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 101, 101 ), ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (14,1) | 100 | 100
 (14,2) | 101 | 101
(6 rows)

abort;
begin;
    -- 2.5. multiple inserts
    insert into :tname values ( 201, 201 ), ( 200, 200 );
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (2,1)  | 400 | 300
 (2,2)  | 400 | 400
 (15,1) | 200 | 200
 (15,2) | 201 | 201
 (16,1) | 100 | 100
 (16,2) | 101 | 101
(8 rows)

abort;
--
-- 3. overlaps with existing blocks, block merging is triggered.
--
begin;
    -- 3.1. one row
    insert into :tname values ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (17,1)
 (17,2)
 (17,3)
(5 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 400 | 300
 400 | 400
(5 rows)

abort;
begin;
    -- 3.2. multiple rows, maybe in different groups
    insert into :tname values ( 300, 300 ), ( 320, 320 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (18,1)
 (18,2)
 (18,3)
 (19,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 320 | 320
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.3. multiple rows, maybe in the same group
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (20,1)
 (20,2)
 (20,3)
 (20,4)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 301, 301 ), ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (21,1)
 (21,2)
 (21,3)
 (21,4)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.5. multiple inserts
    insert into :tname values ( 401, 401 ), ( 400, 400 );
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (22,1)
 (22,2)
 (22,3)
 (22,4)
 (23,1)
 (23,2)
 (23,3)
 (23,4)
(8 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
(8 rows)

abort;
--
-- 4. other tests
--
begin;
    -- 4.1. overlaps with multiple existing blocks
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 401, 401 ), ( 400, 400 );
    select ctid from :tname;
  ctid  
--------
 (24,1)
 (24,2)
 (24,3)
 (24,4)
 (26,1)
 (26,2)
 (26,3)
 (26,4)
 (25,1)
 (25,2)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
 500 | 500
 501 | 501
(10 rows)

abort;
begin;
    -- 4.2. merge multiple times
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 303, 303 ), ( 302, 302 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (2,2)
 (29,1)
 (29,2)
 (29,3)
 (29,4)
 (29,5)
 (29,6)
 (28,1)
 (28,2)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 302 | 302
 303 | 303
 400 | 300
 400 | 400
 500 | 500
 501 | 501
(10 rows)

abort;
-- vi: syntax=sql et :
\set tname test_mars_disordered_insert_group_1_4_order1
\set withopts 'with (group_col_=''{c1}'', group_param_col_=''{c2 in 4}'', local_order_col_=''{c1}'')'
\i sql/disordered_insert.template
create table :tname
     ( c1 int
     , c2 int
     , seg int default 0
     )
 using mars
 :withopts
 distributed by (seg)
;
-- the first batch
insert into :tname
select i / 2 * 100 + 300 as c1
     , i % 2 * 100 + 300 as c2
  from generate_series(0, 3) i
;
-- verify the blocks
select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (2,1) | 300 | 400
 (3,1) | 400 | 300
 (4,1) | 400 | 400
(4 rows)

--
-- 1. insert after existing blocks, no block merging is triggered.
--
begin;
    -- 1.1. one row
    insert into :tname values ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (2,1) | 300 | 400
 (3,1) | 400 | 300
 (4,1) | 400 | 400
 (5,1) | 500 | 500
(5 rows)

abort;
begin;
    -- 1.2. multiple rows, maybe in different groups
    insert into :tname values ( 500, 500 ), ( 520, 520 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (2,1) | 300 | 400
 (3,1) | 400 | 300
 (4,1) | 400 | 400
 (6,1) | 500 | 500
 (7,1) | 520 | 520
(6 rows)

abort;
begin;
    -- 1.3. multiple rows, maybe in the same group
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (2,1) | 300 | 400
 (3,1) | 400 | 300
 (4,1) | 400 | 400
 (8,1) | 500 | 500
 (9,1) | 501 | 501
(6 rows)

abort;
begin;
    -- 1.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 501, 501 ), ( 500, 500 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (10,1) | 501 | 501
 (11,1) | 500 | 500
(6 rows)

abort;
begin;
    -- 1.5. multiple inserts
    insert into :tname values ( 601, 601 ), ( 600, 600 );
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (12,1) | 601 | 601
 (13,1) | 600 | 600
 (14,1) | 500 | 500
 (15,1) | 501 | 501
(8 rows)

abort;
--
-- 2. insert before existing blocks, no block merging is triggered.
--
begin;
    -- 2.1. one row
    insert into :tname values ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (16,1) | 100 | 100
(5 rows)

abort;
begin;
    -- 2.2. multiple rows, maybe in different groups
    insert into :tname values ( 100, 100 ), ( 120, 120 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (17,1) | 100 | 100
 (18,1) | 120 | 120
(6 rows)

abort;
begin;
    -- 2.3. multiple rows, maybe in the same group
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (19,1) | 100 | 100
 (20,1) | 101 | 101
(6 rows)

abort;
begin;
    -- 2.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 101, 101 ), ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (21,1) | 101 | 101
 (22,1) | 100 | 100
(6 rows)

abort;
begin;
    -- 2.5. multiple inserts
    insert into :tname values ( 201, 201 ), ( 200, 200 );
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (23,1) | 201 | 201
 (24,1) | 200 | 200
 (25,1) | 100 | 100
 (26,1) | 101 | 101
(8 rows)

abort;
--
-- 3. overlaps with existing blocks, block merging is triggered.
--
begin;
    -- 3.1. one row
    insert into :tname values ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (4,1)
 (27,1)
 (27,2)
(5 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 400 | 300
 400 | 400
(5 rows)

abort;
begin;
    -- 3.2. multiple rows, maybe in different groups
    insert into :tname values ( 300, 300 ), ( 320, 320 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (4,1)
 (28,1)
 (28,2)
 (29,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 320 | 320
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.3. multiple rows, maybe in the same group
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (4,1)
 (30,1)
 (30,2)
 (31,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 301, 301 ), ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (4,1)
 (33,1)
 (33,2)
 (32,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.5. multiple inserts
    insert into :tname values ( 401, 401 ), ( 400, 400 );
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (35,1)
 (35,2)
 (36,1)
 (36,2)
 (34,1)
 (37,1)
(8 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
(8 rows)

abort;
--
-- 4. other tests
--
begin;
    -- 4.1. overlaps with multiple existing blocks
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 401, 401 ), ( 400, 400 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (38,1)
 (38,2)
 (43,1)
 (43,2)
 (39,1)
 (40,1)
 (41,1)
 (42,1)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
 500 | 500
 501 | 501
(10 rows)

abort;
begin;
    -- 4.2. merge multiple times
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 303, 303 ), ( 302, 302 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (4,1)
 (44,1)
 (44,2)
 (45,1)
 (46,1)
 (47,1)
 (48,1)
 (49,1)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 302 | 302
 303 | 303
 400 | 300
 400 | 400
 500 | 500
 501 | 501
(10 rows)

abort;
-- vi: syntax=sql et :
\set tname test_mars_disordered_insert_group_1_4_order2
\set withopts 'with (group_col_=''{c1}'', group_param_col_=''{c2 in 4}'', local_order_col_=''{c2}'')'
\i sql/disordered_insert.template
create table :tname
     ( c1 int
     , c2 int
     , seg int default 0
     )
 using mars
 :withopts
 distributed by (seg)
;
-- the first batch
insert into :tname
select i / 2 * 100 + 300 as c1
     , i % 2 * 100 + 300 as c2
  from generate_series(0, 3) i
;
-- verify the blocks
select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (2,1) | 300 | 400
 (3,1) | 400 | 300
 (4,1) | 400 | 400
(4 rows)

--
-- 1. insert after existing blocks, no block merging is triggered.
--
begin;
    -- 1.1. one row
    insert into :tname values ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (2,1) | 300 | 400
 (3,1) | 400 | 300
 (4,1) | 400 | 400
 (5,1) | 500 | 500
(5 rows)

abort;
begin;
    -- 1.2. multiple rows, maybe in different groups
    insert into :tname values ( 500, 500 ), ( 520, 520 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (2,1) | 300 | 400
 (3,1) | 400 | 300
 (4,1) | 400 | 400
 (6,1) | 500 | 500
 (7,1) | 520 | 520
(6 rows)

abort;
begin;
    -- 1.3. multiple rows, maybe in the same group
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (2,1) | 300 | 400
 (3,1) | 400 | 300
 (4,1) | 400 | 400
 (8,1) | 500 | 500
 (9,1) | 501 | 501
(6 rows)

abort;
begin;
    -- 1.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 501, 501 ), ( 500, 500 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (10,1) | 501 | 501
 (11,1) | 500 | 500
(6 rows)

abort;
begin;
    -- 1.5. multiple inserts
    insert into :tname values ( 601, 601 ), ( 600, 600 );
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (12,1) | 601 | 601
 (13,1) | 600 | 600
 (14,1) | 500 | 500
 (15,1) | 501 | 501
(8 rows)

abort;
--
-- 2. insert before existing blocks, no block merging is triggered.
--
begin;
    -- 2.1. one row
    insert into :tname values ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (16,1) | 100 | 100
(5 rows)

abort;
begin;
    -- 2.2. multiple rows, maybe in different groups
    insert into :tname values ( 100, 100 ), ( 120, 120 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (17,1) | 100 | 100
 (18,1) | 120 | 120
(6 rows)

abort;
begin;
    -- 2.3. multiple rows, maybe in the same group
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (19,1) | 100 | 100
 (20,1) | 101 | 101
(6 rows)

abort;
begin;
    -- 2.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 101, 101 ), ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (21,1) | 101 | 101
 (22,1) | 100 | 100
(6 rows)

abort;
begin;
    -- 2.5. multiple inserts
    insert into :tname values ( 201, 201 ), ( 200, 200 );
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (23,1) | 201 | 201
 (24,1) | 200 | 200
 (25,1) | 100 | 100
 (26,1) | 101 | 101
(8 rows)

abort;
--
-- 3. overlaps with existing blocks, block merging is triggered.
--
begin;
    -- 3.1. one row
    insert into :tname values ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (4,1)
 (27,1)
 (27,2)
(5 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 400 | 300
 400 | 400
(5 rows)

abort;
begin;
    -- 3.2. multiple rows, maybe in different groups
    insert into :tname values ( 300, 300 ), ( 320, 320 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (4,1)
 (28,1)
 (28,2)
 (29,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 320 | 320
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.3. multiple rows, maybe in the same group
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (4,1)
 (30,1)
 (30,2)
 (31,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 301, 301 ), ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (4,1)
 (33,1)
 (33,2)
 (32,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.5. multiple inserts
    insert into :tname values ( 401, 401 ), ( 400, 400 );
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (35,1)
 (35,2)
 (36,1)
 (36,2)
 (34,1)
 (37,1)
(8 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
(8 rows)

abort;
--
-- 4. other tests
--
begin;
    -- 4.1. overlaps with multiple existing blocks
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 401, 401 ), ( 400, 400 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (38,1)
 (38,2)
 (43,1)
 (43,2)
 (39,1)
 (40,1)
 (41,1)
 (42,1)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
 500 | 500
 501 | 501
(10 rows)

abort;
begin;
    -- 4.2. merge multiple times
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 303, 303 ), ( 302, 302 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (4,1)
 (44,1)
 (44,2)
 (45,1)
 (46,1)
 (47,1)
 (48,1)
 (49,1)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 302 | 302
 303 | 303
 400 | 300
 400 | 400
 500 | 500
 501 | 501
(10 rows)

abort;
-- vi: syntax=sql et :
\set tname test_mars_disordered_insert_group_1_4_order12
\set withopts 'with (group_col_=''{c1}'', group_param_col_=''{c2 in 4}'', local_order_col_=''{c1, c2}'')'
\i sql/disordered_insert.template
create table :tname
     ( c1 int
     , c2 int
     , seg int default 0
     )
 using mars
 :withopts
 distributed by (seg)
;
-- the first batch
insert into :tname
select i / 2 * 100 + 300 as c1
     , i % 2 * 100 + 300 as c2
  from generate_series(0, 3) i
;
-- verify the blocks
select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (2,1) | 300 | 400
 (3,1) | 400 | 300
 (4,1) | 400 | 400
(4 rows)

--
-- 1. insert after existing blocks, no block merging is triggered.
--
begin;
    -- 1.1. one row
    insert into :tname values ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (2,1) | 300 | 400
 (3,1) | 400 | 300
 (4,1) | 400 | 400
 (5,1) | 500 | 500
(5 rows)

abort;
begin;
    -- 1.2. multiple rows, maybe in different groups
    insert into :tname values ( 500, 500 ), ( 520, 520 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (2,1) | 300 | 400
 (3,1) | 400 | 300
 (4,1) | 400 | 400
 (6,1) | 500 | 500
 (7,1) | 520 | 520
(6 rows)

abort;
begin;
    -- 1.3. multiple rows, maybe in the same group
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (2,1) | 300 | 400
 (3,1) | 400 | 300
 (4,1) | 400 | 400
 (8,1) | 500 | 500
 (9,1) | 501 | 501
(6 rows)

abort;
begin;
    -- 1.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 501, 501 ), ( 500, 500 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (10,1) | 501 | 501
 (11,1) | 500 | 500
(6 rows)

abort;
begin;
    -- 1.5. multiple inserts
    insert into :tname values ( 601, 601 ), ( 600, 600 );
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (12,1) | 601 | 601
 (13,1) | 600 | 600
 (14,1) | 500 | 500
 (15,1) | 501 | 501
(8 rows)

abort;
--
-- 2. insert before existing blocks, no block merging is triggered.
--
begin;
    -- 2.1. one row
    insert into :tname values ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (16,1) | 100 | 100
(5 rows)

abort;
begin;
    -- 2.2. multiple rows, maybe in different groups
    insert into :tname values ( 100, 100 ), ( 120, 120 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (17,1) | 100 | 100
 (18,1) | 120 | 120
(6 rows)

abort;
begin;
    -- 2.3. multiple rows, maybe in the same group
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (19,1) | 100 | 100
 (20,1) | 101 | 101
(6 rows)

abort;
begin;
    -- 2.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 101, 101 ), ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (21,1) | 101 | 101
 (22,1) | 100 | 100
(6 rows)

abort;
begin;
    -- 2.5. multiple inserts
    insert into :tname values ( 201, 201 ), ( 200, 200 );
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (2,1)  | 300 | 400
 (3,1)  | 400 | 300
 (4,1)  | 400 | 400
 (23,1) | 201 | 201
 (24,1) | 200 | 200
 (25,1) | 100 | 100
 (26,1) | 101 | 101
(8 rows)

abort;
--
-- 3. overlaps with existing blocks, block merging is triggered.
--
begin;
    -- 3.1. one row
    insert into :tname values ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (4,1)
 (27,1)
 (27,2)
(5 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 400 | 300
 400 | 400
(5 rows)

abort;
begin;
    -- 3.2. multiple rows, maybe in different groups
    insert into :tname values ( 300, 300 ), ( 320, 320 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (4,1)
 (28,1)
 (28,2)
 (29,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 320 | 320
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.3. multiple rows, maybe in the same group
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (4,1)
 (30,1)
 (30,2)
 (31,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 301, 301 ), ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (4,1)
 (33,1)
 (33,2)
 (32,1)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.5. multiple inserts
    insert into :tname values ( 401, 401 ), ( 400, 400 );
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (35,1)
 (35,2)
 (36,1)
 (36,2)
 (34,1)
 (37,1)
(8 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
(8 rows)

abort;
--
-- 4. other tests
--
begin;
    -- 4.1. overlaps with multiple existing blocks
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 401, 401 ), ( 400, 400 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (38,1)
 (38,2)
 (43,1)
 (43,2)
 (39,1)
 (40,1)
 (41,1)
 (42,1)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
 500 | 500
 501 | 501
(10 rows)

abort;
begin;
    -- 4.2. merge multiple times
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 303, 303 ), ( 302, 302 );
    select ctid from :tname;
  ctid  
--------
 (2,1)
 (3,1)
 (4,1)
 (44,1)
 (44,2)
 (45,1)
 (46,1)
 (47,1)
 (48,1)
 (49,1)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 302 | 302
 303 | 303
 400 | 300
 400 | 400
 500 | 500
 501 | 501
(10 rows)

abort;
-- vi: syntax=sql et :
\set tname test_mars_disordered_insert_group_0_0_order1
\set withopts 'with (local_order_col_=''{c1}'')'
\i sql/disordered_insert.template
create table :tname
     ( c1 int
     , c2 int
     , seg int default 0
     )
 using mars
 :withopts
 distributed by (seg)
;
-- the first batch
insert into :tname
select i / 2 * 100 + 300 as c1
     , i % 2 * 100 + 300 as c2
  from generate_series(0, 3) i
;
-- verify the blocks
select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
(4 rows)

--
-- 1. insert after existing blocks, no block merging is triggered.
--
begin;
    -- 1.1. one row
    insert into :tname values ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
 (2,1) | 500 | 500
(5 rows)

abort;
begin;
    -- 1.2. multiple rows, maybe in different groups
    insert into :tname values ( 500, 500 ), ( 520, 520 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
 (3,1) | 500 | 500
 (3,2) | 520 | 520
(6 rows)

abort;
begin;
    -- 1.3. multiple rows, maybe in the same group
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
 (4,1) | 500 | 500
 (4,2) | 501 | 501
(6 rows)

abort;
begin;
    -- 1.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 501, 501 ), ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
 (5,1) | 500 | 500
 (5,2) | 501 | 501
(6 rows)

abort;
begin;
    -- 1.5. multiple inserts
    insert into :tname values ( 601, 601 ), ( 600, 600 );
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
 (6,1) | 600 | 600
 (6,2) | 601 | 601
 (7,1) | 500 | 500
 (7,2) | 501 | 501
(8 rows)

abort;
--
-- 2. insert before existing blocks, no block merging is triggered.
--
begin;
    -- 2.1. one row
    insert into :tname values ( 100, 100 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
 (8,1) | 100 | 100
(5 rows)

abort;
begin;
    -- 2.2. multiple rows, maybe in different groups
    insert into :tname values ( 100, 100 ), ( 120, 120 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
 (9,1) | 100 | 100
 (9,2) | 120 | 120
(6 rows)

abort;
begin;
    -- 2.3. multiple rows, maybe in the same group
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (1,3)  | 400 | 300
 (1,4)  | 400 | 400
 (10,1) | 100 | 100
 (10,2) | 101 | 101
(6 rows)

abort;
begin;
    -- 2.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 101, 101 ), ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (1,3)  | 400 | 300
 (1,4)  | 400 | 400
 (11,1) | 100 | 100
 (11,2) | 101 | 101
(6 rows)

abort;
begin;
    -- 2.5. multiple inserts
    insert into :tname values ( 201, 201 ), ( 200, 200 );
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (1,3)  | 400 | 300
 (1,4)  | 400 | 400
 (12,1) | 200 | 200
 (12,2) | 201 | 201
 (13,1) | 100 | 100
 (13,2) | 101 | 101
(8 rows)

abort;
--
-- 3. overlaps with existing blocks, block merging is triggered.
--
begin;
    -- 3.1. one row
    insert into :tname values ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (14,1)
(5 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 400 | 300
 400 | 400
(5 rows)

abort;
begin;
    -- 3.2. multiple rows, maybe in different groups
    insert into :tname values ( 300, 300 ), ( 320, 320 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (15,1)
 (15,2)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 320 | 320
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.3. multiple rows, maybe in the same group
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (16,1)
 (16,2)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 301, 301 ), ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (17,1)
 (17,2)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.5. multiple inserts
    insert into :tname values ( 401, 401 ), ( 400, 400 );
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (18,1)
 (18,2)
 (19,1)
 (19,2)
(8 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
(8 rows)

abort;
--
-- 4. other tests
--
begin;
    -- 4.1. overlaps with multiple existing blocks
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 401, 401 ), ( 400, 400 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (20,1)
 (20,2)
 (20,3)
 (20,4)
 (20,5)
 (20,6)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
 500 | 500
 501 | 501
(10 rows)

abort;
begin;
    -- 4.2. merge multiple times
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 303, 303 ), ( 302, 302 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (21,1)
 (21,2)
 (21,3)
 (21,4)
 (21,5)
 (21,6)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 302 | 302
 303 | 303
 400 | 300
 400 | 400
 500 | 500
 501 | 501
(10 rows)

abort;
-- vi: syntax=sql et :
\set tname test_mars_disordered_insert_group_0_0_order2
\set withopts 'with (local_order_col_=''{c2}'')'
\i sql/disordered_insert.template
create table :tname
     ( c1 int
     , c2 int
     , seg int default 0
     )
 using mars
 :withopts
 distributed by (seg)
;
-- the first batch
insert into :tname
select i / 2 * 100 + 300 as c1
     , i % 2 * 100 + 300 as c2
  from generate_series(0, 3) i
;
-- verify the blocks
select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 400 | 300
 (1,3) | 300 | 400
 (1,4) | 400 | 400
(4 rows)

--
-- 1. insert after existing blocks, no block merging is triggered.
--
begin;
    -- 1.1. one row
    insert into :tname values ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 400 | 300
 (1,3) | 300 | 400
 (1,4) | 400 | 400
 (2,1) | 500 | 500
(5 rows)

abort;
begin;
    -- 1.2. multiple rows, maybe in different groups
    insert into :tname values ( 500, 500 ), ( 520, 520 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 400 | 300
 (1,3) | 300 | 400
 (1,4) | 400 | 400
 (3,1) | 500 | 500
 (3,2) | 520 | 520
(6 rows)

abort;
begin;
    -- 1.3. multiple rows, maybe in the same group
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 400 | 300
 (1,3) | 300 | 400
 (1,4) | 400 | 400
 (4,1) | 500 | 500
 (4,2) | 501 | 501
(6 rows)

abort;
begin;
    -- 1.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 501, 501 ), ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 400 | 300
 (1,3) | 300 | 400
 (1,4) | 400 | 400
 (5,1) | 500 | 500
 (5,2) | 501 | 501
(6 rows)

abort;
begin;
    -- 1.5. multiple inserts
    insert into :tname values ( 601, 601 ), ( 600, 600 );
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 400 | 300
 (1,3) | 300 | 400
 (1,4) | 400 | 400
 (6,1) | 600 | 600
 (6,2) | 601 | 601
 (7,1) | 500 | 500
 (7,2) | 501 | 501
(8 rows)

abort;
--
-- 2. insert before existing blocks, no block merging is triggered.
--
begin;
    -- 2.1. one row
    insert into :tname values ( 100, 100 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 400 | 300
 (1,3) | 300 | 400
 (1,4) | 400 | 400
 (8,1) | 100 | 100
(5 rows)

abort;
begin;
    -- 2.2. multiple rows, maybe in different groups
    insert into :tname values ( 100, 100 ), ( 120, 120 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 400 | 300
 (1,3) | 300 | 400
 (1,4) | 400 | 400
 (9,1) | 100 | 100
 (9,2) | 120 | 120
(6 rows)

abort;
begin;
    -- 2.3. multiple rows, maybe in the same group
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 400 | 300
 (1,3)  | 300 | 400
 (1,4)  | 400 | 400
 (10,1) | 100 | 100
 (10,2) | 101 | 101
(6 rows)

abort;
begin;
    -- 2.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 101, 101 ), ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 400 | 300
 (1,3)  | 300 | 400
 (1,4)  | 400 | 400
 (11,1) | 100 | 100
 (11,2) | 101 | 101
(6 rows)

abort;
begin;
    -- 2.5. multiple inserts
    insert into :tname values ( 201, 201 ), ( 200, 200 );
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 400 | 300
 (1,3)  | 300 | 400
 (1,4)  | 400 | 400
 (12,1) | 200 | 200
 (12,2) | 201 | 201
 (13,1) | 100 | 100
 (13,2) | 101 | 101
(8 rows)

abort;
--
-- 3. overlaps with existing blocks, block merging is triggered.
--
begin;
    -- 3.1. one row
    insert into :tname values ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (14,1)
(5 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 400 | 300
 400 | 400
(5 rows)

abort;
begin;
    -- 3.2. multiple rows, maybe in different groups
    insert into :tname values ( 300, 300 ), ( 320, 320 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (15,1)
 (15,2)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 320 | 320
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.3. multiple rows, maybe in the same group
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (16,1)
 (16,2)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 301, 301 ), ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (17,1)
 (17,2)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.5. multiple inserts
    insert into :tname values ( 401, 401 ), ( 400, 400 );
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (18,1)
 (18,2)
 (19,1)
 (19,2)
(8 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
(8 rows)

abort;
--
-- 4. other tests
--
begin;
    -- 4.1. overlaps with multiple existing blocks
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 401, 401 ), ( 400, 400 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (20,1)
 (20,2)
 (20,3)
 (20,4)
 (20,5)
 (20,6)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
 500 | 500
 501 | 501
(10 rows)

abort;
begin;
    -- 4.2. merge multiple times
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 303, 303 ), ( 302, 302 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (21,1)
 (21,2)
 (21,3)
 (21,4)
 (21,5)
 (21,6)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 302 | 302
 303 | 303
 400 | 300
 400 | 400
 500 | 500
 501 | 501
(10 rows)

abort;
-- vi: syntax=sql et :
\set tname test_mars_disordered_insert_group_0_0_order12
\set withopts 'with (local_order_col_=''{c1, c2}'')'
\i sql/disordered_insert.template
create table :tname
     ( c1 int
     , c2 int
     , seg int default 0
     )
 using mars
 :withopts
 distributed by (seg)
;
-- the first batch
insert into :tname
select i / 2 * 100 + 300 as c1
     , i % 2 * 100 + 300 as c2
  from generate_series(0, 3) i
;
-- verify the blocks
select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
(4 rows)

--
-- 1. insert after existing blocks, no block merging is triggered.
--
begin;
    -- 1.1. one row
    insert into :tname values ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
 (2,1) | 500 | 500
(5 rows)

abort;
begin;
    -- 1.2. multiple rows, maybe in different groups
    insert into :tname values ( 500, 500 ), ( 520, 520 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
 (3,1) | 500 | 500
 (3,2) | 520 | 520
(6 rows)

abort;
begin;
    -- 1.3. multiple rows, maybe in the same group
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
 (4,1) | 500 | 500
 (4,2) | 501 | 501
(6 rows)

abort;
begin;
    -- 1.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 501, 501 ), ( 500, 500 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
 (5,1) | 500 | 500
 (5,2) | 501 | 501
(6 rows)

abort;
begin;
    -- 1.5. multiple inserts
    insert into :tname values ( 601, 601 ), ( 600, 600 );
    insert into :tname values ( 500, 500 ), ( 501, 501 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
 (6,1) | 600 | 600
 (6,2) | 601 | 601
 (7,1) | 500 | 500
 (7,2) | 501 | 501
(8 rows)

abort;
--
-- 2. insert before existing blocks, no block merging is triggered.
--
begin;
    -- 2.1. one row
    insert into :tname values ( 100, 100 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
 (8,1) | 100 | 100
(5 rows)

abort;
begin;
    -- 2.2. multiple rows, maybe in different groups
    insert into :tname values ( 100, 100 ), ( 120, 120 );
    select ctid, c1, c2 from :tname;
 ctid  | c1  | c2  
-------+-----+-----
 (1,1) | 300 | 300
 (1,2) | 300 | 400
 (1,3) | 400 | 300
 (1,4) | 400 | 400
 (9,1) | 100 | 100
 (9,2) | 120 | 120
(6 rows)

abort;
begin;
    -- 2.3. multiple rows, maybe in the same group
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (1,3)  | 400 | 300
 (1,4)  | 400 | 400
 (10,1) | 100 | 100
 (10,2) | 101 | 101
(6 rows)

abort;
begin;
    -- 2.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 101, 101 ), ( 100, 100 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (1,3)  | 400 | 300
 (1,4)  | 400 | 400
 (11,1) | 100 | 100
 (11,2) | 101 | 101
(6 rows)

abort;
begin;
    -- 2.5. multiple inserts
    insert into :tname values ( 201, 201 ), ( 200, 200 );
    insert into :tname values ( 100, 100 ), ( 101, 101 );
    select ctid, c1, c2 from :tname;
  ctid  | c1  | c2  
--------+-----+-----
 (1,1)  | 300 | 300
 (1,2)  | 300 | 400
 (1,3)  | 400 | 300
 (1,4)  | 400 | 400
 (12,1) | 200 | 200
 (12,2) | 201 | 201
 (13,1) | 100 | 100
 (13,2) | 101 | 101
(8 rows)

abort;
--
-- 3. overlaps with existing blocks, block merging is triggered.
--
begin;
    -- 3.1. one row
    insert into :tname values ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (14,1)
(5 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 400 | 300
 400 | 400
(5 rows)

abort;
begin;
    -- 3.2. multiple rows, maybe in different groups
    insert into :tname values ( 300, 300 ), ( 320, 320 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (15,1)
 (15,2)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 320 | 320
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.3. multiple rows, maybe in the same group
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (16,1)
 (16,2)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.4. multiple rows, maybe in the same group, wrong order
    insert into :tname values ( 301, 301 ), ( 300, 300 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (17,1)
 (17,2)
(6 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
(6 rows)

abort;
begin;
    -- 3.5. multiple inserts
    insert into :tname values ( 401, 401 ), ( 400, 400 );
    insert into :tname values ( 300, 300 ), ( 301, 301 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (18,1)
 (18,2)
 (19,1)
 (19,2)
(8 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
(8 rows)

abort;
--
-- 4. other tests
--
begin;
    -- 4.1. overlaps with multiple existing blocks
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 401, 401 ), ( 400, 400 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (20,1)
 (20,2)
 (20,3)
 (20,4)
 (20,5)
 (20,6)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 400 | 300
 400 | 400
 400 | 400
 401 | 401
 500 | 500
 501 | 501
(10 rows)

abort;
begin;
    -- 4.2. merge multiple times
    insert into :tname values ( 300, 300 ), ( 301, 301 )
                            , ( 501, 501 ), ( 500, 500 )
                            , ( 303, 303 ), ( 302, 302 );
    select ctid from :tname;
  ctid  
--------
 (1,1)
 (1,2)
 (1,3)
 (1,4)
 (21,1)
 (21,2)
 (21,3)
 (21,4)
 (21,5)
 (21,6)
(10 rows)

    select c1, c2 from :tname order by c1, c2;
 c1  | c2  
-----+-----
 300 | 300
 300 | 300
 300 | 400
 301 | 301
 302 | 302
 303 | 303
 400 | 300
 400 | 400
 500 | 500
 501 | 501
(10 rows)

abort;
-- vi: syntax=sql et :
-- vi: et :
